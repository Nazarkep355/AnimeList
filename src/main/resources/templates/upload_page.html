<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="#{title.uploadPage}"></title>
    <style>
        .progress {
            height: 20px;
            border-radius: 4px;
            margin: 10px 0;
            background-color: #e6e8ec;
        }
    </style>
</head>
<body>
<div th:insert="header.html::header"></div>
<div style="background: black">
    <div class="container">
        <div class="container mx-1">
            <div style="background: white;min-height: 687px">
                <div style="min-height: 40px"></div>
                <div class="container mx-3">
                    <div class="container " ng-app="uploadFormApp" id="uploadApp">
                        <div class="mx-auto mb-3" style="max-width: 450px;align-self: center">
                            <form id="uploadForm" th:action="@{/admin/upload}"
                                  method="post" ng-controller="formCtrl">
                                <input name="anime" ng-model="name_field" ng-change="search()" id="field-name" type="text"
                                       class="form-control "
                                       th:placeholder="#{title.animeTitle}"
                                       aria-describedby="basic-addon2">
                                <div id="name_options" style="z-index:10000;margin-left: 0px;position:absolute;max-width:350px;
                            max-height: 90px;background: white;">
                                    <div name-option style="z-index:10000;margin-left: 3px;margin-top:3px;min-height: 30px;
                                     max-height:30px; min-width: 350px;border:solid black 1px;
                          color:black;cursor: pointer;"
                                         ng-repeat="anime in animes" >{{anime.title}}
                                    </div>
                                </div>
                                <div class="form-floating mt-3">
                                    <input type="number" class="form-control" value="1" id="floatingInput"
                                      name="episode_num"     placeholder="name@example.com" min="1" max="{{anime.episodesNumber}}">
                                    <label for="floatingInput" th:text="#{title.episode}"></label>
                                </div>
                                <div class="input-group mb-3 mt-3">
                                    <input type="file" name="file" class="form-control" id="fileInput">
                                </div>
                                <div style="max-width: 300px" class="progress"></div>
                                <div class=" container mx-auto" style="text-align: center">
                                    <button type="submit" name="file" style="align-self: center"
                                            class="btn btn-primary btn-lg">Large button
                                    </button>
                                </div>
                            </form>
                        </div>
                        <script>
                            upFormApp = angular.module('uploadFormApp', [])

                            upFormApp.controller('formCtrl', function ($scope, $http) {
                                $scope.search = function () {
                                    if ($scope.name_field.length > 2) {
                                        $http.get("/search/" + $scope.name_field + "?size=3")
                                            .then
                                            (function (response) {
                                                $scope.animes = response.data.content;
                                                document.getElementById('name_options').style.visibility = 'visible'

                                            }, function (error) {
                                                alert(error.message)
                                            });
                                    } else {
                                        $scope.animes = []
                                    }
                                }
                            })


                            upFormApp.directive('nameOption', function () {
                                return {
                                    scope: true,
                                    link: function (scope, element, attr) {
                                        element.on('click', function () {
                                            console.log(scope.animes)
                                            document.getElementById('field-name').value = element.text()
                                            scope.anime = scope.animes
                                                .filter((a) => a.title.trim() === element.text().trim())
                                                .pop()
                                            document.getElementById('name_options').style.visibility='hidden'
                                        })
                                    }
                                }
                            })


                            angular.bootstrap(document.getElementById('uploadApp'), ['uploadFormApp'])
                        </script>
                    </div>
                    <script>
                        uploadForm = document.getElementById('uploadForm')
                        filesInput = document.getElementById('fileInput')
                        uploadForm.onsubmit = event => {
                            event.preventDefault();
                            // Make sure files are selected
                            if (filesInput.files.length < 1) {
                                uploadForm.querySelector('button').innerHTML = 'Please select a file!';
                            } else {
                                // Create the form object
                                let uploadFormDate = new FormData(uploadForm);
                                // Initiate the AJAX request
                                let request = new XMLHttpRequest();
                                // Ensure the request method is POST
                                request.open('POST', uploadForm.action);
                                // Attach the progress event handler to the AJAX request
                                request.upload.addEventListener('progress', event => {
                                    // Add the current progress to the button
                                    uploadForm.querySelector('button').innerHTML = 'Uploading... ' + '(' + ((event.loaded / event.total) * 100).toFixed(2) + '%)';
                                    // Update the progress bar
                                    uploadForm.querySelector('.progress').style.background = 'linear-gradient(to right, #25b350, #25b350 ' + Math.round((event.loaded / event.total) * 100)
                                        + '%, #e6e8ec ' + Math.round((event.loaded / event.total) * 100) + '%)';
                                    // Disable the submit button
                                    uploadForm.querySelector('button').disabled = true;
                                });
                                // The following code will execute when the request is complete
                                request.onreadystatechange = () => {
                                    if (request.readyState == 4 && request.status == 200) {
                                        // Output the response message
                                        uploadForm.querySelector('.result').innerHTML = request.responseText;
                                    }
                                };
                                // Execute request
                                request.send(uploadFormDate);
                            }
                        };


                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<!--                            <div style="z-index:10000;margin-left: 0px;position:absolute;max-width:350px;-->
<!--                            max-height: 600px;background: white;border: black 1px">-->
<!--                                <div style="z-index:10000;margin-left: 3px;-->
<!--                                margin-top:3px;min-height: 160px; max-height:160px; min-width: 350px;-->
<!--                          color:black"-->
<!--                                     ng-repeat="anime in animes"-->
<!--                                >-->
<!--                                    <div>-->
<!--                                        <a href="/anime/{{anime.id}}"-->
<!--                                           style="z-index:10000;text-decoration: none; color: black">{{anime.title}}</a>-->
<!--                                    </div>-->

<!--                                </div>-->
<!--                            </div>-->